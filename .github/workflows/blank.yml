name: Pull allow-domains and build unified list

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"   # ежедневно в 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: allow-domains-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self
        uses: actions/checkout@v4

      - name: Checkout external repo
        uses: actions/checkout@v4
        with:
          repository: itdoginfo/allow-domains
          ref: main
          path: external
          fetch-depth: 1

      - name: Build combined allow-domains
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "Russia/inside-raw.lst"
            "Categories/hodca.lst"
            "Categories/anime.lst"
            "Categories/geoblock.lst"
            "Services/cloudflare.lst"
            "Services/cloudfront.lst"
            "Services/discord.lst"
            "Services/google_ai.lst"
            "Services/google_play.lst"
            "Services/hdrezka.lst"
            "Services/meta.lst"
            "Services/telegram.lst"
            "Services/tiktok.lst"
            "Subnets/IPv4/Discord.lst"
            "Subnets/IPv4/Meta.lst"
            "Subnets/IPv4/cloudflare.lst"
            "Subnets/IPv4/cloudfront.lst"
            "Subnets/IPv4/digitalocean.lst"
            "Subnets/IPv4/discord.lst"
            "Subnets/IPv4/hetzner.lst"
            "Subnets/IPv4/meta.lst"
            "Subnets/IPv4/ovh.lst"
            "Subnets/IPv4/telegram.lst"
          )

          outfile="allow-domains"
          tmpfile="$(mktemp)"

          # commit SHA внешнего репо (чтобы было понятно, что именно подтянули)
          ext_sha="$(git -C external rev-parse --short HEAD)"

          # Склейка + базовая нормализация:
          # - убираем CR (\r)
          # - убираем пустые строки
          # - (опционально) можно отфильтровать комментарии: /^[[:space:]]*#/ {next}
          for f in "${files[@]}"; do
            src="external/$f"
            [[ -f "$src" ]] || { echo "ERROR: missing file: $src" >&2; exit 1; }

            sed -e 's/\r$//' "$src" \
              | awk 'NF { print }' \
              >> "$tmpfile"
          done

          {
            echo "# Combined allow-domains list"
            echo "# Source repo: itdoginfo/allow-domains (branch: main, sha: ${ext_sha})"
            echo "# Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "# Files order:"
            for f in "${files[@]}"; do echo "#  - $f"; done
            echo
            # Дедуп строк с сохранением порядка
            awk '!seen[$0]++' "$tmpfile"
          } > "$outfile"

          rm -f "$tmpfile"

          echo "Built $outfile"
          echo "Lines: $(wc -l < "$outfile")"

      - name: Commit & push (only if changed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- allow-domains; then
            echo "No changes to commit"
            exit 0
          fi

          git add -f allow-domains
          git commit -m "Auto-update allow-domains [skip ci]"
          git push origin "HEAD:${{ github.ref_name }}"
