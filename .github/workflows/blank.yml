name: Pull allow-domains and build unified list

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"   # ежедневно в 03:00 UTC
  workflow_dispatch:       # ручной запуск

permissions:
  contents: write          # нужно для коммита результата

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Твой репозиторий
      - name: Checkout self
        uses: actions/checkout@v4

      # 2) Внешний репозиторий
      - name: Checkout external repo
        uses: actions/checkout@v4
        with:
          repository: itdoginfo/allow-domains
          ref: main
          path: external
          fetch-depth: 1

      # 3) Сборка списка + удаление дубликатов (без смены порядка)
      - name: Build combined allow-domains
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "Russia/inside-raw.lst"
            "Categories/hodca.lst"
            "Categories/anime.lst"
            "Categories/geoblock.lst"
            "Services/cloudflare.lst"
            "Services/cloudfront.lst"
            "Services/discord.lst"
            "Services/google_ai.lst"
            "Services/google_play.lst"
            "Services/hdrezka.lst"
            "Services/meta.lst"
            "Services/telegram.lst"
            "Services/tiktok.lst"
            "Subnets/IPv4/Discord.lst"
            "Subnets/IPv4/Meta.lst"
            "Subnets/IPv4/cloudflare.lst"
            "Subnets/IPv4/cloudfront.lst"
            "Subnets/IPv4/digitalocean.lst"
            "Subnets/IPv4/discord.lst"
            "Subnets/IPv4/hetzner.lst"
            "Subnets/IPv4/meta.lst"
            "Subnets/IPv4/ovh.lst"
            "Subnets/IPv4/telegram.lst"
          )

          outfile="allow-domains"
          tmpfile="$(mktemp)"

          # Проверка наличия и склейка
          for f in "${files[@]}"; do
            src="external/$f"
            if [[ ! -f "$src" ]]; then
              echo "ERROR: missing file: $src" >&2
              exit 1
            fi
            cat "$src" >> "$tmpfile"
            echo >> "$tmpfile"
          done

          {
            echo "# Combined allow-domains list"
            echo "# Source repo: itdoginfo/allow-domains (branch: main)"
            echo "# Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "# Files order:"
            for f in "${files[@]}"; do echo "#  - $f"; done
            echo
            # Удаляем дубликаты строк, сохраняя первый вхождение и исходный порядок
            awk '!seen[$0]++' "$tmpfile"
          } > "$outfile"

          rm -f "$tmpfile"
          echo "Built $outfile with $(wc -l < "$outfile") lines"

      # 4) Коммит и пуш в текущую ветку
      - name: Commit & push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -f allow-domains
          git commit -m "Auto-update allow-domains [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}
