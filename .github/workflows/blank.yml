name: Pull allow-domains and build unified list

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"   # ежедневно в 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: allow-domains-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self
        uses: actions/checkout@v4

      - name: Checkout external repo
        uses: actions/checkout@v4
        with:
          repository: itdoginfo/allow-domains
          ref: main
          path: external
          fetch-depth: 1

      - name: Build combined allow-domains (1 file, ignore invalid)
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "Russia/inside-raw.lst"
            "Categories/hodca.lst"
            "Categories/anime.lst"
            "Categories/geoblock.lst"
            "Services/cloudflare.lst"
            "Services/cloudfront.lst"
            "Services/discord.lst"
            "Services/google_ai.lst"
            "Services/google_play.lst"
            "Services/hdrezka.lst"
            "Services/meta.lst"
            "Services/telegram.lst"
            "Services/tiktok.lst"
            "Subnets/IPv4/Discord.lst"
            "Subnets/IPv4/Meta.lst"
            "Subnets/IPv4/cloudflare.lst"
            "Subnets/IPv4/cloudfront.lst"
            "Subnets/IPv4/digitalocean.lst"
            "Subnets/IPv4/discord.lst"
            "Subnets/IPv4/hetzner.lst"
            "Subnets/IPv4/meta.lst"
            "Subnets/IPv4/ovh.lst"
            "Subnets/IPv4/telegram.lst"
          )

          outfile="allow-domains"
          tmpfile="$(mktemp)"

          # commit SHA внешнего репо для прозрачности
          ext_sha="$(git -C external rev-parse --short HEAD)"

          # 1) Склейка исходников в заданном порядке
          for f in "${files[@]}"; do
            src="external/$f"
            [[ -f "$src" ]] || { echo "ERROR: missing file: $src" >&2; exit 1; }
            cat "$src" >> "$tmpfile"
            echo >> "$tmpfile"
          done

          # 2) Нормализация + дедуп + мягкая валидация (invalid игнорируем)
          python3 - "$tmpfile" "$outfile" "$ext_sha" <<'PY'
import re, sys, ipaddress, pathlib

tmp = pathlib.Path(sys.argv[1])
out = pathlib.Path(sys.argv[2])
ext_sha = sys.argv[3]

# Домен:
# - допускаем ведущую точку (".ua")
# - ASCII / punycode
domain_re = re.compile(
    r"^\.?("
    r"(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+"
    r"(?:[a-z]{2,63}|xn--[a-z0-9-]{2,59})"
    r")$",
    re.IGNORECASE
)

def is_ip_or_cidr(s: str) -> bool:
    try:
        if "/" in s:
            ipaddress.ip_network(s, strict=False)
        else:
            ipaddress.ip_address(s)
        return True
    except Exception:
        return False

seen = set()
result = []
invalid = []

for idx, raw in enumerate(tmp.read_text(encoding="utf-8", errors="replace").splitlines(), start=1):
    # нормализация: CRLF + trim + убрать хвостовые пробелы
    s = raw.replace("\r", "").strip()

    # пустые и комментарии пропускаем
    if not s or s.startswith("#"):
        continue

    # дедуп, сохраняя первое вхождение
    if s in seen:
        continue

    ok = (domain_re.match(s) is not None) or is_ip_or_cidr(s)
    if not ok:
        invalid.append((idx, raw))
        continue

    seen.add(s)
    result.append(s)

out.write_text("\n".join(result) + "\n", encoding="utf-8")

print(f"OK: wrote {len(result)} valid entries to {out} (external sha: {ext_sha})")
if invalid:
    print(f"WARNING: ignored {len(invalid)} invalid lines (showing up to 50):")
    for ln, val in invalid[:50]:
        print(f"  {ln}: {val!r}")
PY

          rm -f "$tmpfile"

      - name: Commit & push (only if changed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- allow-domains; then
            echo "No changes to commit"
            exit 0
          fi

          git add -f allow-domains
          git commit -m "Auto-update allow-domains [skip ci]"
          git push origin "HEAD:${{ github.ref_name }}"
