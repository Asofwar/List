name: Pull allow-domains and build unified list

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"     # ежедневно в 03:00 UTC
  workflow_dispatch:         # запуск вручную

permissions:
  contents: write            # нужно для коммита изменений

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Чекаут твоего репозитория
      - name: Checkout self
        uses: actions/checkout@v4

      # 2. Чекаут внешнего репозитория
      - name: Checkout external repo
        uses: actions/checkout@v4
        with:
          repository: itdoginfo/allow-domains
          ref: main
          path: external
          fetch-depth: 1

      # 3. Собрать указанные файлы в один и удалить дубликаты
      - name: Build combined allow-domains file
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "Russia/inside-raw.lst"
            "Categories/hodca.lst"
            "Categories/anime.lst"
            "Categories/geoblock.lst"
            "Services/cloudflare.lst"
            "Services/cloudfront.lst"
            "Services/discord.lst"
            "Services/google_ai.lst"
            "Services/google_play.lst"
            "Services/hdrezka.lst"
            "Services/meta.lst"
            "Services/telegram.lst"
            "Services/tiktok.lst"
            "Subnets/IPv4/Discord.lst"
            "Subnets/IPv4/Meta.lst"
            "Subnets/IPv4/cloudflare.lst"
            "Subnets/IPv4/cloudfront.lst"
            "Subnets/IPv4/digitalocean.lst"
            "Subnets/IPv4/discord.lst"
            "Subnets/IPv4/hetzner.lst"
            "Subnets/IPv4/meta.lst"
            "Subnets/IPv4/ovh.lst"
            "Subnets/IPv4/telegram.lst"
          )

          outfile="allow-domains"

          echo "# Combined allow-domains list" > "$outfile"
          echo "# Source: itdoginfo/allow-domains (branch: main)" >> "$outfile"
          echo "# Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$outfile"
          echo "# Files:" >> "$outfile"
          for f in "${files[@]}"; do echo "#  - $f" >> "$outfile"; done
          echo >> "$outfile"

          tmpfile=$(mktemp)

          for f in "${files[@]}"; do
            src="external/$f"
            if [[ -f "$src" ]]; then
              cat "$src" >> "$tmpfile"
              echo >> "$tmpfile"
            else
              echo "⚠️  Missing: $src" >&2
            fi
          done

          # Удаляем дубликаты и пустые строки
          sort -u "$tmpfile" | sed '/^$/d' >> "$outfile"

          echo "✅ Created $outfile with $(wc -l < "$outfile") lines"
          rm "$tmpfile"

      # 4. Коммит и пуш результата
      - name: Commit & push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add allow-domains
          git diff --quiet && echo "No changes" || git commit -m "Auto-update allow-domains [skip ci]"
          git push
